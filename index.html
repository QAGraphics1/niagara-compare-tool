<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Niagara Navigator - Point Explorer</title>
    <style>
        :root {
            /* BAS Professional Color Palette */
            --primary-color: #0B4C5F;
            --secondary-color: #2C3E50;
            --accent-color: #3498DB;
            --success-color: #27AE60;
            --warning-color: #F39C12;
            --error-color: #E74C3C;
            --background-color: #F7F9FB;
            --surface-color: #FFFFFF;
            --text-primary: #2C3E50;
            --text-secondary: #6C757D;
            --text-muted: #95A5A6;
            --border-color: #E1E8ED;
            --shadow-light: 0 2px 4px rgba(44, 62, 80, 0.08);
            --shadow-medium: 0 4px 12px rgba(44, 62, 80, 0.12);
            --shadow-heavy: 0 8px 25px rgba(44, 62, 80, 0.15);
            --radius-small: 6px;
            --radius-medium: 8px;
            --radius-large: 12px;
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', sans-serif;
            background: var(--background-color);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            overflow: hidden;
            font-weight: 400;
        }
        
        .app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: var(--primary-color);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-medium);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            font-size: 12px;
            opacity: 0.9;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .toolbar {
            background: var(--surface-color);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            box-shadow: var(--shadow-light);
        }

        .btn {
            padding: 10px 16px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-radius: var(--radius-small);
            color: var(--text-primary);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--background-color);
            border-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }

        .btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            box-shadow: var(--shadow-light);
        }

        .btn.primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: 600;
        }

        .btn.primary:hover {
            background: #094046;
            border-color: #094046;
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .sidebar {
            width: 320px;
            background: var(--surface-color);
            border-right: 1px solid var(--border-color);
            padding: 24px;
            overflow-y: auto;
            box-shadow: var(--shadow-light);
        }

        .content {
            flex: 1;
            background: var(--background-color);
            overflow-y: auto;
        }
        
        .detail-panel {
            width: 420px;
            background: var(--surface-color);
            border-left: 1px solid var(--border-color);
            padding: 0;
            overflow-y: auto;
            display: none;
            box-shadow: var(--shadow-medium);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .detail-panel.show {
            display: block;
            transform: translateX(0);
        }
        
        /* Tree Styles */
        .tree {
            font-family: var(--font-family);
            font-size: 13px;
            padding: 24px;
            background: var(--surface-color);
            border-radius: var(--radius-medium);
            margin: 16px;
            box-shadow: var(--shadow-light);
        }

        .tree-item {
            padding: 8px 12px;
            border-radius: var(--radius-small);
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            position: relative;
            margin: 2px 0;
        }

        .tree-item:hover {
            background: var(--background-color);
            transform: translateX(4px);
            box-shadow: var(--shadow-light);
        }

        .tree-item.device {
            font-weight: 600;
            color: var(--primary-color);
        }

        .tree-item.device:hover {
            background: rgba(11, 76, 95, 0.08);
            border-left: 3px solid var(--primary-color);
        }

        .tree-item.selected {
            background: var(--accent-color);
            color: white;
            box-shadow: var(--shadow-medium);
        }

        .tree-item.point {
            font-style: italic;
            color: var(--text-muted);
            padding-left: 32px;
        }

        .tree-item.point:hover {
            background: rgba(245, 166, 35, 0.1);
            border-left: 3px solid var(--accent-color);
        }

        /* Expand button styles */
        .expand-btn {
            width: 16px;
            height: 16px;
            background: var(--primary-color);
            color: white;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .expand-btn:hover {
            background: var(--accent-color);
            transform: scale(1.1);
        }

        .expand-spacer {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .node-icon {
            flex-shrink: 0;
        }

        .node-name {
            flex-grow: 1;
        }

        .tree-children {
            margin-left: 24px;
            display: none;
            border-left: 2px solid var(--border-color);
            margin-top: 4px;
            padding-left: 8px;
        }

        .tree-children.open {
            display: block;
        }

        .tree-toggle {
            width: 16px;
            height: 16px;
            cursor: pointer;
            transition: transform 0.2s ease;
            color: var(--text-secondary);
        }

        .tree-toggle.expanded {
            transform: rotate(90deg);
        }

        .tree-icon {
            color: var(--accent-color);
        }

        .tree-icon.device {
            color: var(--success-color);
        }

        .tree-icon.junk {
            color: var(--text-muted);
        }
        
        .point {
            padding: 6px 12px;
            border-radius: var(--radius-small);
            cursor: copy;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            transition: var(--transition);
            margin: 1px 0;
        }

        .point:hover {
            background: rgba(52, 152, 219, 0.08);
            transform: translateX(6px);
            color: var(--accent-color);
            box-shadow: var(--shadow-light);
        }

        .point-icon {
            width: 12px;
            height: 12px;
            fill: var(--accent-color);
            flex-shrink: 0;
        }

        .point-name {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }
        
        /* Templates Report */
        .templates-report {
            padding: 20px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .summary-stats {
            display: flex;
            gap: 40px;
            margin-top: 15px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
        }
        
        .template-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .template-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .template-count {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }
        
        .device-item {
            background: #f8f9fa;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            border-left: 3px solid #3498db;
            cursor: help;
        }
        
        .points-summary {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
            font-size: 12px;
            color: #6c757d;
        }

        .points-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .expand-points-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--accent-color);
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            transition: var(--transition);
        }

        .expand-points-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        .points-expanded {
            margin-top: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 4px;
        }

        .template-point-item {
            padding: 4px 8px;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: var(--transition);
        }

        .template-point-item:hover {
            background: var(--accent-color);
            color: white;
        }

        /* Template Naming and Time Inputs */
        .template-name-input {
            background: transparent;
            border: 1px solid transparent;
            font-weight: 600;
            font-size: 16px;
            padding: 4px 8px;
            border-radius: 4px;
            color: inherit;
            width: 100%;
            max-width: 300px;
        }

        .template-name-input:hover,
        .template-name-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            outline: none;
        }

        .template-time-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            font-size: 14px;
            color: #6c757d;
        }

        .template-hours-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            color: var(--text-primary);
            font-size: 14px;
        }

        .template-hours-input:hover,
        .template-hours-input:focus {
            border-color: var(--accent-color);
            background: #f8f9fa;
            outline: none;
        }

        .template-hours-input::placeholder {
            color: #6c757d;
        }

        .export-quote-section {
            margin-top: 16px;
            text-align: center;
        }

        .quote-export {
            background: var(--success-color) !important;
            border-color: var(--success-color) !important;
        }

        .quote-export:hover {
            background: #219a52 !important;
            border-color: #219a52 !important;
        }

        /* Detail Panel */
        .detail-header {
            background: var(--primary-color);
            color: white;
            padding: 20px 24px;
            margin: 0;
            box-shadow: var(--shadow-light);
        }

        .detail-header h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .detail-header .device-path {
            font-size: 12px;
            opacity: 0.9;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .detail-section {
            margin: 16px 24px;
            padding: 16px;
            background: var(--background-color);
            border-radius: var(--radius-medium);
            border: 1px solid var(--border-color);
        }

        .detail-section h4 {
            margin: 0 0 12px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Clickable device links in detail panel */
        .device-link {
            padding: 4px 8px;
            margin: 4px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .device-link:hover {
            background: #3498db !important;
            color: white !important;
            transform: translateX(4px);
        }
        
        .device-link.current {
            background: #3498db;
            color: white;
        }
        
        /* Copyable points in detail panel */
        .detail-point {
            padding: 4px;
            margin: 2px 0;
            cursor: copy;
            border-radius: 4px;
            transition: all 0.2s;
            color: #495057;
        }
        
        .detail-point:hover {
            background: #e8f4fd;
            transform: translateX(2px);
        }
        
        .detail-point::before {
            content: 'â€¢ ';
            color: #6c757d;
        }
        
        /* Partial match differences */
        .diff-point {
            padding: 3px 6px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .diff-point.missing {
            background: #ffebee;
            color: #c62828;
        }
        
        .diff-point.extra {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        /* Status */
        .file-info {
            padding: 16px;
            background: var(--surface-color);
            border-radius: var(--radius-medium);
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
        }

        .file-info strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .tips-section {
            background: var(--surface-color);
            border-radius: var(--radius-medium);
            padding: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            font-size: 11px;
            line-height: 1.4;
        }

        .tips-section strong {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        /* Configuration Panel */
        .config-section {
            background: var(--surface-color);
            border-radius: var(--radius-medium);
            padding: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            margin-bottom: 16px;
        }

        .config-section h4 {
            margin: 0 0 12px 0;
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .config-group {
            margin-bottom: 12px;
        }

        .config-group label {
            display: block;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .config-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-small);
            font-size: 11px;
            background: var(--background-color);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .config-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .config-display {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-small);
            font-size: 11px;
            background: var(--background-color);
            color: var(--text-secondary);
            font-family: monospace;
        }

        /* Export Section */
        .export-section {
            background: var(--surface-color);
            border-radius: var(--radius-medium);
            padding: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            margin-bottom: 16px;
        }

        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn-export {
            padding: 8px 12px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--radius-small);
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: var(--transition);
            text-align: center;
        }

        .btn-export:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }

        .btn-export.secondary {
            background: var(--secondary-color);
        }

        .btn-export.secondary:hover {
            background: #1a252f;
        }
        
        .stats-mini {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-mini {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            padding: 16px;
            border-radius: var(--radius-medium);
            text-align: center;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-mini:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .stat-mini::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-color);
        }

        .stat-mini-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .stat-mini-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--surface-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 16px 20px;
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-heavy);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            max-width: 350px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--error-color);
        }

        .toast-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            color: var(--success-color);
        }

        .toast.error .toast-icon {
            color: var(--error-color);
        }
        
        input[type="file"] {
            display: none;
        }

        /* SVG Icons */
        .icon {
            width: 16px;
            height: 16px;
            fill: currentColor;
            flex-shrink: 0;
        }

        .icon-large {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <!-- SVG Icon Definitions -->
    <svg style="display: none">
        <defs>
            <symbol id="icon-folder" viewBox="0 0 24 24">
                <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
            </symbol>
            <symbol id="icon-folder-open" viewBox="0 0 24 24">
                <path d="M19 20H4c-1.11 0-2-.89-2-2V6c0-1.11.89-2 2-2h6l2 2h7c1.11 0 2 .89 2 2H4v10l1.14-4.58c.25-.99 1.12-1.7 2.15-1.7H21c.46 0 .86.28 1.03.67L19 20z"/>
            </symbol>
            <symbol id="icon-device" viewBox="0 0 24 24">
                <path d="M20 3H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h3l-1 1v2h12v-2l-1-1h3c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 13H4V5h16v11z"/>
            </symbol>
            <symbol id="icon-point" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="4"/>
                <path d="M16 8v5h3v-5zM2 8v5h3v-5z"/>
            </symbol>
            <symbol id="icon-tree" viewBox="0 0 24 24">
                <path d="M22 11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3z"/>
            </symbol>
            <symbol id="icon-templates" viewBox="0 0 24 24">
                <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h16c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
            </symbol>
            <symbol id="icon-expand" viewBox="0 0 24 24">
                <path d="M12 5.83L15.17 9l1.41-1.41L12 3 7.41 7.59 8.83 9 12 5.83zm0 12.34L8.83 15l-1.41 1.41L12 21l4.59-4.59L15.17 15 12 18.17z"/>
            </symbol>
            <symbol id="icon-collapse" viewBox="0 0 24 24">
                <path d="M7.41 18.59L8.83 20 12 16.83 15.17 20l1.41-1.41L12 14l-4.59 4.59zm9.18-13.18L15.17 4 12 7.17 8.83 4 7.41 5.41 12 10l4.59-4.59z"/>
            </symbol>
            <symbol id="icon-close" viewBox="0 0 24 24">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </symbol>
            <symbol id="icon-upload" viewBox="0 0 24 24">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
            </symbol>
            <symbol id="icon-chart" viewBox="0 0 24 24">
                <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
            </symbol>
            <symbol id="icon-chevron-right" viewBox="0 0 24 24">
                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
            </symbol>
            <symbol id="icon-chevron-down" viewBox="0 0 24 24">
                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
            </symbol>
            <symbol id="icon-building" viewBox="0 0 24 24">
                <path d="M12 2L2 7v10c0 5.55 3.84 9.71 9 11 5.16-1.29 9-5.45 9-11V7l-10-5z"/>
            </symbol>
        </defs>
    </svg>
    <div class="app">
        <div class="header">
            <h1>
                <svg class="icon icon-large"><use href="#icon-building"></use></svg>
                Niagara Navigator
            </h1>
            <div class="header-info">
                <div class="header-status">
                    <span class="status-dot"></span>
                    <span>System Ready</span>
                </div>
                <span>v4 Structural - ${new Date().toLocaleString()}</span>
            </div>
        </div>

        <div class="toolbar">
            <button class="btn primary" onclick="openFile()">
                <svg class="icon"><use href="#icon-upload"></use></svg>
                Open CSV
            </button>
            <button class="btn" onclick="openCompareFile()" id="compareBogBtn" style="display: none;">
                <svg class="icon"><use href="#icon-upload"></use></svg>
                Compare CSV
            </button>
            <button class="btn" onclick="clearComparison()" id="clearComparisonBtn" style="display: none;">
                <svg class="icon"><use href="#icon-close"></use></svg>
                Clear Comparison
            </button>
            <button class="btn active" onclick="showView('tree')">
                <svg class="icon"><use href="#icon-tree"></use></svg>
                Tree
            </button>
            <button class="btn" onclick="showView('templates')">
                <svg class="icon"><use href="#icon-templates"></use></svg>
                Templates
            </button>
            <button class="btn" onclick="showView('comparison')" id="comparisonBtn" style="display: none;">
                <svg class="icon"><use href="#icon-chart"></use></svg>
                Comparison
            </button>
            <button class="btn" onclick="expandAll()">
                <svg class="icon"><use href="#icon-expand"></use></svg>
                Expand
            </button>
            <button class="btn" onclick="collapseAll()">
                <svg class="icon"><use href="#icon-collapse"></use></svg>
                Collapse
            </button>
            <button class="btn" onclick="downloadJSON()">
                <svg class="icon"><use href="#icon-chart"></use></svg>
                Export JSON
            </button>
            <button class="btn" onclick="closeDetail()">
                <svg class="icon"><use href="#icon-close"></use></svg>
                Close Detail
            </button>
        </div>
        
        <div class="main">
            <div class="sidebar">
                <div class="file-info">
                    <input type="file" id="fileInput" accept=".csv" onchange="loadFile(event)">
                    <input type="file" id="compareFileInput" accept=".csv" onchange="loadCompareFile(event)" style="display: none;">
                    <strong>File:</strong> <span id="fileName">None</span>
                    <div id="compareFileInfo" style="display: none; margin-top: 8px;">
                        <strong>Compare:</strong> <span id="compareFileName">None</span>
                    </div>
                </div>

                <div class="stats-mini">
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="deviceCount">0</div>
                        <div class="stat-mini-label">Devices</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="pointCount">0</div>
                        <div class="stat-mini-label">Points</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="templateCount">0</div>
                        <div class="stat-mini-label">Templates</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="partialCount">0</div>
                        <div class="stat-mini-label">Partials</div>
                    </div>
                </div>

                <div class="config-section">
                    <h4>Configuration</h4>
                    <div class="config-group">
                        <label for="detectedDrivers">Detected Drivers</label>
                        <div id="detectedDrivers" class="config-display">None detected</div>
                    </div>
                    <div class="config-group">
                        <label for="serverUrl">Server URL</label>
                        <input type="text" id="serverUrl" class="config-input" value="{server}" onchange="updateServerUrl()" placeholder="https://your-server.com">
                    </div>
                </div>

                <div class="export-section">
                    <h4>Export Options</h4>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="downloadJSON()">
                            ðŸ“¥ Download JSON
                        </button>
                        <button class="btn-export secondary" onclick="copyJSONToClipboard()">
                            ðŸ“‹ Copy to Clipboard
                        </button>
                        <button class="btn-export secondary" onclick="openDashboardBuilder()">
                            ðŸŽ¨ Open Dashboard Builder
                        </button>
                    </div>
                </div>

                <div class="tips-section">
                    <strong>Tips</strong>
                    â€¢ Click device â†’ see template<br>
                    â€¢ Click point â†’ copy ORD<br>
                    â€¢ Click devices in detail panel<br>
                    â€¢ Export JSON â†’ dashboard builder
                </div>
            </div>
            
            <div class="content">
                <div id="treeView" class="tree"></div>
                <div id="templatesView" class="templates-report" style="display: none;"></div>
                <div id="comparisonView" class="templates-report" style="display: none;"></div>
            </div>
            
            <div id="detailPanel" class="detail-panel"></div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>

    <script>
        // Global state
        let appData = null;
        let compareData = null;
        let templateSettings = {};

        // Template settings management
        function updateTemplateName(index, name) {
            if (!templateSettings[index]) templateSettings[index] = {};
            templateSettings[index].name = name;

            // Refresh the templates view if currently visible
            if (currentView === 'templates') {
                updateTemplates();
            }
        }

        function updateTemplateHours(index, hours) {
            if (!templateSettings[index]) templateSettings[index] = {};
            templateSettings[index].hours = parseFloat(hours) || 0;

            // Refresh the templates view if currently visible
            if (currentView === 'templates') {
                updateTemplates();
            }
        }

        function hasConfiguredTemplates() {
            return Object.values(templateSettings).some(s => s.name && s.hours > 0);
        }
        let currentView = 'tree';
        let comparisonActive = false;
        
        // File handling
        function openFile() {
            document.getElementById('fileInput').click();
        }
        
        async function loadFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = file.name;

            try {
                const csvContent = await loadCSV(file);
                appData = processCSV(csvContent);
                updateDisplay();
                showToast('File loaded successfully');

                // Show compare button after first file is loaded
                document.getElementById('compareBogBtn').style.display = 'inline-flex';
            } catch (error) {
                console.error('Error:', error);
                showToast('Error loading file');
            }
        }

        function openCompareFile() {
            document.getElementById('compareFileInput').click();
        }

        async function loadCompareFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('compareFileName').textContent = file.name;

            try {
                const csvContent = await loadCSV(file);
                compareData = processCSV(csvContent);
                comparisonActive = true;

                // Show comparison UI elements
                document.getElementById('compareFileInfo').style.display = 'block';
                document.getElementById('clearComparisonBtn').style.display = 'inline-flex';
                document.getElementById('comparisonBtn').style.display = 'inline-flex';

                updateDisplay();
                showToast('Comparison file loaded successfully');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error loading comparison file');
            }
        }

        function clearComparison() {
            compareData = null;
            comparisonActive = false;

            // Hide comparison UI elements
            document.getElementById('compareFileInfo').style.display = 'none';
            document.getElementById('clearComparisonBtn').style.display = 'none';
            document.getElementById('comparisonBtn').style.display = 'none';

            // Clear file input
            document.getElementById('compareFileInput').value = '';

            updateDisplay();
            showToast('Comparison cleared');
        }
        
        async function loadCSV(file) {
            if (!file.name.endsWith('.csv')) {
                throw new Error('Please upload a CSV file');
            }
            return await file.text();
        }
        


        function processCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length === 0) {
                throw new Error('Empty CSV file');
            }

            // Parse CSV - assume first line is header
            const header = lines[0].split(',');
            const objectIndex = header.findIndex(col => col.toLowerCase().includes('object'));

            if (objectIndex === -1) {
                throw new Error('No Object column found in CSV');
            }

            // Step 1: Build path tree and collect all paths
            const pathTree = {};
            const allPaths = new Set();
            const pointPaths = new Set();

            // Process each CSV row (skip header)
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const cols = line.split(',');
                const pointPath = cols[objectIndex]?.trim();

                if (!pointPath || !pointPath.startsWith('/Drivers/')) continue;

                allPaths.add(pointPath);
                pointPaths.add(pointPath);

                // Build tree structure
                const segments = pointPath.split('/').filter(s => s);
                let currentNode = pathTree;
                let currentPath = '';

                segments.forEach((segment, index) => {
                    currentPath += '/' + segment;

                    if (!currentNode[segment]) {
                        currentNode[segment] = {
                            name: segment,
                            path: currentPath,
                            children: {},
                            isPoint: false,
                            points: [],
                            isEquipment: false
                        };
                    }

                    // Mark as point if it's the final segment
                    if (index === segments.length - 1) {
                        currentNode[segment].isPoint = true;
                    }

                    allPaths.add(currentPath);
                    currentNode = currentNode[segment].children;
                });
            }

            console.log('Built path tree with', allPaths.size, 'total paths and', pointPaths.size, 'point paths');

            // Step 2: Identify equipment by working backwards from each point
            const equipmentMap = new Map();
            const points = new Map();

            pointPaths.forEach(pointPath => {
                const segments = pointPath.split('/').filter(s => s);
                const pointName = segments.pop(); // Remove the point name

                // Determine equipment by working backwards
                let equipmentPath;
                let equipmentName;

                if (segments.length > 0 && segments[segments.length - 1] === 'points') {
                    // If parent is "points", equipment is one level up
                    segments.pop(); // Remove "points"
                    if (segments.length > 0) {
                        equipmentName = segments[segments.length - 1];
                        equipmentPath = '/' + segments.join('/');
                    } else {
                        // Edge case: if we have /points/pointName, skip it
                        return;
                    }
                } else {
                    // Otherwise, parent folder is the equipment
                    if (segments.length > 0) {
                        equipmentName = segments[segments.length - 1];
                        equipmentPath = '/' + segments.join('/');
                    } else {
                        // Edge case: point at root level, skip it
                        return;
                    }
                }

                // Create equipment if it doesn't exist
                if (!equipmentMap.has(equipmentPath)) {
                    equipmentMap.set(equipmentPath, {
                        name: equipmentName,
                        path: equipmentPath,
                        points: [],
                        hasPointsFolder: pointPath.includes('/points/')
                    });
                }

                // Create point object
                const point = {
                    name: pointName,
                    path: pointPath,
                    hasPointsFolder: pointPath.includes('/points/'),
                    equipmentPath: equipmentPath
                };

                // Add point to maps
                points.set(pointPath, point);
                equipmentMap.get(equipmentPath).points.push(point);
            });

            console.log('Found', equipmentMap.size, 'equipment and', points.size, 'points');

            // Add equipment paths to allPaths for tree building
            equipmentMap.forEach((equipment, equipmentPath) => {
                allPaths.add(equipmentPath);
                // Also add intermediate paths
                const segments = equipmentPath.split('/').filter(s => s);
                let buildPath = '';
                segments.forEach(segment => {
                    buildPath += '/' + segment;
                    allPaths.add(buildPath);
                });
            });

            // Convert to arrays and sort
            const devices = Array.from(equipmentMap.values());
            devices.forEach(device => {
                device.points.sort((a, b) => a.name.localeCompare(b.name));
            });

            // Find templates
            const templates = findTemplates(devices);

            // Detect driver types from CSV paths
            const driverTypes = new Set();
            allPaths.forEach(path => {
                const driverMatch = path.match(/\/Drivers\/([^\/]+)/);
                if (driverMatch) {
                    driverTypes.add(driverMatch[1]);
                }
            });

            const detectedDrivers = Array.from(driverTypes);
            let primaryDriver = 'BacnetNetwork';
            if (detectedDrivers.includes('BacnetNetwork')) {
                primaryDriver = 'BacnetNetwork';
            } else if (detectedDrivers.includes('ModbusNetwork')) {
                primaryDriver = 'ModbusNetwork';
            } else if (detectedDrivers.includes('LonNetwork')) {
                primaryDriver = 'LonNetwork';
            } else if (detectedDrivers.length > 0) {
                primaryDriver = detectedDrivers[0];
            }

            // Update global detectedConfig
            window.detectedConfig = {
                driverType: primaryDriver,
                stationPrefix: 'station:',
                detectedDrivers: detectedDrivers
            };

            // Build tree
            const tree = buildTree(Array.from(allPaths), devices);

            const detectedConfig = {
                drivers: detectedDrivers,
                format: 'CSV',
                totalPaths: allPaths.size,
                pointCount: points.size,
                equipmentCount: devices.length
            };

            console.log('CSV Processing Results:', {
                devices: devices.length,
                points: points.size,
                templates: templates.exact.length
            });

            return { devices, points, templates, tree, paths: Array.from(allPaths), detectedConfig };
        }

        function findTemplates(devices) {
            const exact = [];
            const used = new Set();
            
            devices.forEach(device => {
                if (used.has(device.name)) return;
                
                const template = {
                    points: device.points,
                    devices: [device]
                };
                
                used.add(device.name);
                
                devices.forEach(other => {
                    if (used.has(other.name)) return;
                    if (device.points.length !== other.points.length) return;
                    
                    const match = device.points.every((p, i) => 
                        p.name === other.points[i].name
                    );
                    
                    if (match) {
                        template.devices.push(other);
                        used.add(other.name);
                    }
                });
                
                exact.push(template);
            });
            
            // Find partials
            const partial = [];
            exact.forEach((t1, i) => {
                exact.forEach((t2, j) => {
                    if (i >= j) return;
                    
                    const matching = t1.points.filter(p1 => 
                        t2.points.some(p2 => p1.name === p2.name)
                    ).length;
                    
                    const total = Math.max(t1.points.length, t2.points.length);
                    const percent = Math.round((matching / total) * 100);
                    
                    if (percent >= 80 && percent < 100) {
                        partial.push({ t1, t2, percent, matching, total });
                    }
                });
            });
            
            return { exact, partial };
        }
        
        function buildTree(paths, devices) {
            const root = { name: 'Station', children: [] };
            
            paths.forEach(path => {
                // Include all paths for complete tree structure - don't skip nested paths
                
                const parts = path.split('/').filter(p => p);
                let current = root;
                
                parts.forEach(part => {
                    let child = current.children.find(c => c.name === part);
                    if (!child) {
                        child = { name: part, children: [] };
                        current.children.push(child);
                    }
                    current = child;
                });
            });
            
            // Mark folders with equipment using new generic detection
            function markHasEquipment(node, path = '') {
                const currentPath = path ? `${path}/${node.name}` : `/${node.name}`;
                let hasEquipment = false;

                // Check if this node is equipment (found in our equipment map)
                const device = devices.find(d => d.path === currentPath);
                if (device) {
                    hasEquipment = true;
                    node.isDirectDevice = true;
                }

                // Check all children recursively
                node.children.forEach(child => {
                    if (markHasEquipment(child, currentPath)) {
                        hasEquipment = true;
                    }
                });

                // Set the flag on this node
                if (hasEquipment) {
                    node.hasEquipment = true;
                }

                return hasEquipment;
            }
            
            markHasEquipment(root);
            
            return root;
        }
        
        // Display functions
        function updateDisplay() {
            if (!appData) return;

            // Update stats
            document.getElementById('deviceCount').textContent = appData.devices.length;
            document.getElementById('pointCount').textContent = appData.points.size;
            document.getElementById('templateCount').textContent = appData.templates.exact.length;
            document.getElementById('partialCount').textContent = appData.templates.partial.length;

            // Update detected drivers display
            updateDetectedDriversDisplay();

            // Update views
            updateTree();
            updateTemplates();

            // Update comparison if active
            if (comparisonActive) {
                updateComparison();
            }
        }
        
        function updateTree() {
            const container = document.getElementById('treeView');
            container.innerHTML = '';
            
            const drivers = appData.tree.children.find(c => c.name === 'Drivers');
            if (drivers) {
                renderNode(drivers, container, 0, '');
            }
        }
        
        function renderNode(node, container, level, path) {
            const currentPath = path ? `${path}/${node.name}` : `/${node.name}`;
            const isPoints = node.name === 'points';
            const device = appData.devices.find(d => d.path === currentPath);
            const hasChildren = Object.keys(node.children).length > 0;

            // Check if this node is a point (any leaf node that isn't a "points" folder)
            const isActualPoint = !hasChildren && !isPoints;

            const item = document.createElement('div');
            item.className = 'tree-item';

            // Mark equipment for styling but don't change behavior
            if (device) {
                item.classList.add('device');
            }

            item.style.paddingLeft = `${level * 20}px`;

            // Create the tree item content with expand button if has children
            let itemContent = '';

            if (hasChildren) {
                itemContent += `<span class="expand-btn" data-path="${currentPath}">+</span>`;
            } else {
                itemContent += `<span class="expand-spacer"></span>`;
            }
            
            // Determine icon based on node type
            let icon = 'ðŸ“‚'; // Default folder icon
            if (isPoints) {
                icon = 'ðŸ“Š';
            } else if (device) {
                icon = 'âš™ï¸';
            } else if (node.isPoint || isActualPoint) {
                icon = 'â€¢'; // Bullet point like in detail pane
            }

            // Add icon and node name
            if (node.isPoint || isActualPoint) {
                itemContent += `<span class="node-icon">${icon}</span><span class="node-name point">${node.name}</span>`;
                item.className += ' point';
            } else if (device) {
                itemContent += `<span class="node-icon">${icon}</span><span class="node-name"><strong>${node.name}</strong></span>`;
            } else {
                itemContent += `<span class="node-icon">${icon}</span><span class="node-name">${node.name}</span>`;
            }

            item.innerHTML = itemContent;

            // Add click handler for node selection
            item.onclick = (e) => {
                // Don't select if clicking expand button
                if (e.target.classList.contains('expand-btn')) {
                    return;
                }

                // Remove previous selection
                document.querySelectorAll('.tree-item.selected').forEach(el =>
                    el.classList.remove('selected'));

                // Select this item
                item.classList.add('selected');

                // Show details if this is equipment
                if (device) {
                    showDeviceDetail(currentPath);
                } else if (node.isPoint || isActualPoint) {
                    // For points, copy ORD
                    copyORD({name: node.name, path: currentPath});
                }
            };

            container.appendChild(item);

            // Create child container if node has children
            if (hasChildren) {
                const childContainer = document.createElement('div');
                childContainer.className = 'tree-children';
                container.appendChild(childContainer);

                // Add expand button handler
                const expandBtn = item.querySelector('.expand-btn');
                expandBtn.onclick = (e) => {
                    e.stopPropagation();
                    const isOpen = childContainer.classList.contains('open');
                    if (isOpen) {
                        childContainer.classList.remove('open');
                        expandBtn.textContent = '+';
                    } else {
                        childContainer.classList.add('open');
                        expandBtn.textContent = '-';
                    }
                };

                // Render all children
                Object.values(node.children).forEach(child => {
                    renderNode(child, childContainer, level + 1, currentPath);
                });
            }
        }
        
        function updateTemplates() {
            const container = document.getElementById('templatesView');
            const sorted = [...appData.templates.exact].sort((a, b) => b.devices.length - a.devices.length);
            
            let html = `
                <div class="summary-card">
                    <h2>ðŸ“‹ Templates Report</h2>
                    <div class="summary-stats">
                        <div class="stat">
                            <div class="stat-value">${sorted.length}</div>
                            <div class="stat-label">Unique Templates</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${appData.devices.length}</div>
                            <div class="stat-label">Total Devices</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${(appData.devices.length / sorted.length).toFixed(1)}</div>
                            <div class="stat-label">Avg per Template</div>
                        </div>
                    </div>
                    ${hasConfiguredTemplates() ?
                        `<div class="export-quote-section">
                            <button class="btn-export quote-export" onclick="exportQuote()">
                                ðŸ“ Export Quote/Scope
                            </button>
                        </div>` : ''}
                </div>
            `;
            
            sorted.forEach((t, i) => {
                const originalIndex = appData.templates.exact.indexOf(t);
                const percent = ((t.devices.length / appData.devices.length) * 100).toFixed(1);

                html += `
                    <div class="template-card">
                        <div class="template-header">
                            <input type="text" class="template-name-input"
                                   placeholder="Template ${i + 1}"
                                   value="${templateSettings[originalIndex]?.name || ''}"
                                   onchange="updateTemplateName(${originalIndex}, this.value)">
                            <span class="template-count">${t.devices.length} devices (${percent}%)</span>
                        </div>
                        <div class="template-time-input-row">
                            <label>Hours per unit:</label>
                            <input type="number" class="template-hours-input"
                                   placeholder="0.0" step="0.5" min="0"
                                   value="${templateSettings[originalIndex]?.hours || ''}"
                                   onchange="updateTemplateHours(${originalIndex}, this.value)">
                        </div>
                        <div class="device-grid">
                            ${t.devices.map(d => `<div class="device-item" title="${d.ord || d.path}">${d.name}</div>`).join('')}
                        </div>
                        <div class="points-summary">
                            <div class="points-header">
                                <strong>${t.points.length} Points:</strong>
                                ${t.points.length > 8 ? `<button class="expand-points-btn" data-template="${i}" onclick="togglePoints(${i})">â–¶</button>` : ''}
                            </div>
                            <div class="points-preview" id="points-preview-${i}">
                                ${t.points.slice(0, 8).map(p => p.name).join(', ')}
                                ${t.points.length > 8 ? '...' : ''}
                            </div>
                            <div class="points-expanded" id="points-expanded-${i}" style="display: none;">
                                ${t.points.map(p =>
                                    `<div class="template-point-item" onclick="copyORD({name:'${p.name}', path:'${p.path}'})" title="Click to copy ORD">â€¢ ${p.name}</div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function togglePoints(templateIndex) {
            const previewEl = document.getElementById(`points-preview-${templateIndex}`);
            const expandedEl = document.getElementById(`points-expanded-${templateIndex}`);
            const buttonEl = document.querySelector(`[data-template="${templateIndex}"]`);

            if (expandedEl.style.display === 'none') {
                // Expand
                previewEl.style.display = 'none';
                expandedEl.style.display = 'grid';
                buttonEl.textContent = 'â–¼';
            } else {
                // Collapse
                previewEl.style.display = 'block';
                expandedEl.style.display = 'none';
                buttonEl.textContent = 'â–¶';
            }
        }

        function generateComparisonReport() {
            if (!appData || !compareData) return;

            const primary = appData.devices;
            const secondary = compareData.devices;

            // Create device maps for easy lookup
            const primaryMap = new Map(primary.map(d => [d.path, d]));
            const secondaryMap = new Map(secondary.map(d => [d.path, d]));

            // Find differences
            const onlyInPrimary = primary.filter(d => !secondaryMap.has(d.path));
            const onlyInSecondary = secondary.filter(d => !primaryMap.has(d.path));
            const inBoth = primary.filter(d => secondaryMap.has(d.path));

            // Analyze point differences for common equipment
            const pointDifferences = [];
            inBoth.forEach(primaryDevice => {
                const secondaryDevice = secondaryMap.get(primaryDevice.path);
                const primaryPoints = new Set(primaryDevice.points.map(p => p.name));
                const secondaryPoints = new Set(secondaryDevice.points.map(p => p.name));

                const missingInSecondary = primaryDevice.points.filter(p => !secondaryPoints.has(p.name));
                const missingInPrimary = secondaryDevice.points.filter(p => !primaryPoints.has(p.name));

                if (missingInSecondary.length > 0 || missingInPrimary.length > 0) {
                    pointDifferences.push({
                        device: primaryDevice,
                        missingInSecondary,
                        missingInPrimary
                    });
                }
            });

            return {
                onlyInPrimary,
                onlyInSecondary,
                inBoth,
                pointDifferences,
                primaryName: document.getElementById('fileName').textContent,
                secondaryName: document.getElementById('compareFileName').textContent
            };
        }

        function updateComparison() {
            const container = document.getElementById('comparisonView');
            const comparison = generateComparisonReport();

            if (!comparison) {
                container.innerHTML = '<p>No comparison data available</p>';
                return;
            }

            let html = `
                <div class="summary-card">
                    <h2>ðŸ” CSV Comparison Report</h2>
                    <div style="margin-top: 15px; font-size: 14px;">
                        <div><strong>Primary:</strong> ${comparison.primaryName}</div>
                        <div><strong>Compare:</strong> ${comparison.secondaryName}</div>
                    </div>
                    <div class="summary-stats">
                        <div class="stat">
                            <div class="stat-value">${comparison.onlyInPrimary.length}</div>
                            <div class="stat-label">Only in Primary</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${comparison.onlyInSecondary.length}</div>
                            <div class="stat-label">Only in Compare</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${comparison.inBoth.length}</div>
                            <div class="stat-label">In Both</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${comparison.pointDifferences.length}</div>
                            <div class="stat-label">Point Differences</div>
                        </div>
                    </div>
                </div>
            `;

            // Only in Primary
            if (comparison.onlyInPrimary.length > 0) {
                html += `
                    <div class="template-card">
                        <div class="template-header">
                            <span class="template-title">Equipment Only in Primary</span>
                            <span class="template-count">${comparison.onlyInPrimary.length} devices</span>
                        </div>
                        <div class="device-grid">
                            ${comparison.onlyInPrimary.map(d => `<div class="device-item" style="border-left-color: #e74c3c;">${d.name} (${d.points.length} points)</div>`).join('')}
                        </div>
                    </div>
                `;
            }

            // Only in Secondary
            if (comparison.onlyInSecondary.length > 0) {
                html += `
                    <div class="template-card">
                        <div class="template-header">
                            <span class="template-title">Equipment Only in Compare</span>
                            <span class="template-count">${comparison.onlyInSecondary.length} devices</span>
                        </div>
                        <div class="device-grid">
                            ${comparison.onlyInSecondary.map(d => `<div class="device-item" style="border-left-color: #27ae60;">${d.name} (${d.points.length} points)</div>`).join('')}
                        </div>
                    </div>
                `;
            }

            // Point Differences
            if (comparison.pointDifferences.length > 0) {
                html += `
                    <div class="template-card">
                        <div class="template-header">
                            <span class="template-title">Equipment with Point Differences</span>
                            <span class="template-count">${comparison.pointDifferences.length} devices</span>
                        </div>
                `;

                comparison.pointDifferences.forEach(diff => {
                    html += `
                        <div style="margin: 16px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #f39c12;">
                            <div style="font-weight: 600; margin-bottom: 8px;">${diff.device.name}</div>

                            ${diff.missingInSecondary.length > 0 ? `
                                <div style="margin: 8px 0;">
                                    <div style="font-size: 12px; font-weight: 500; color: #e74c3c; margin-bottom: 4px;">
                                        Missing in Compare (${diff.missingInSecondary.length}):
                                    </div>
                                    <div style="font-size: 11px; color: #666;">
                                        ${diff.missingInSecondary.map(p => p.name).join(', ')}
                                    </div>
                                </div>
                            ` : ''}

                            ${diff.missingInPrimary.length > 0 ? `
                                <div style="margin: 8px 0;">
                                    <div style="font-size: 12px; font-weight: 500; color: #27ae60; margin-bottom: 4px;">
                                        Missing in Primary (${diff.missingInPrimary.length}):
                                    </div>
                                    <div style="font-size: 11px; color: #666;">
                                        ${diff.missingInPrimary.map(p => p.name).join(', ')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += `</div>`;
            }

            container.innerHTML = html;
        }
        
        // ORD Translation Engine
        class ORDTranslator {
            constructor(config = {}) {
                this.driverType = config.driverType || 'BacnetNetwork';
                this.stationPrefix = config.stationPrefix || 'station:';
                this.serverUrl = config.serverUrl || '{server}';
            }

            translate(csvPath, pointName = null) {
                const clean = this.cleanPath(csvPath);
                const isPoint = pointName !== null;
                const fullPath = isPoint ? `${clean}/points/${pointName}` : clean;

                return {
                    csvPath: csvPath,
                    cleanPath: clean,
                    ord: this.toORD(fullPath),
                    obixPath: this.toObixPath(fullPath),
                    obixValueUrl: this.toObixValueUrl(fullPath),
                    foxUrl: this.toFoxUrl(fullPath),
                    isPoint: isPoint
                };
            }

            cleanPath(path) {
                // Remove common extensions
                let clean = path.replace(/\/(HistoryExt|NumericInterval|AlarmExt|StatusExt)$/, '');

                // Decode URL encoding
                clean = decodeURIComponent(clean);
                clean = clean.replace(/%5/g, '/').replace(/%20/g, ' ');

                // Strip prefixes
                clean = clean.replace(/^\/Eureka/, '');
                clean = clean.replace(/^\/slot/, '');
                clean = clean.replace(/^\/config/, '');

                // Handle $ encoding
                clean = clean.replace(/\$2d/g, '-');
                clean = clean.replace(/\$20/g, ' ');
                clean = clean.replace(/\$2f/g, '/');
                clean = clean.replace(/\$2c/g, ',');
                clean = clean.replace(/\$2e/g, '.');
                clean = clean.replace(/\$3a/g, ':');

                return clean;
            }

            toORD(path) {
                // Multiple pattern support
                if (path.startsWith('/devices/')) {
                    return `${this.stationPrefix}|slot:/Drivers/${this.driverType}${path.substring(8)}`;
                }
                if (path.includes('/Drivers/')) {
                    return `${this.stationPrefix}|slot:${path}`;
                }
                return `${this.stationPrefix}|slot:/Config${path}`;
            }

            toObixPath(path) {
                const ord = this.toORD(path);
                return ord.replace(`${this.stationPrefix}|slot:`, '/obix/config');
            }

            toObixValueUrl(path) {
                const obixPath = this.toObixPath(path);
                return `${obixPath}/out/value`;
            }

            toFoxUrl(path) {
                const ord = this.toORD(path);
                return ord.replace(`${this.stationPrefix}|slot:`, `fox://${this.stationPrefix.replace(':', '')}`);
            }
        }

        // Global ORD translator instance
        let ordTranslator = new ORDTranslator();
        let detectedConfig = {
            driverType: 'BacnetNetwork',
            stationPrefix: 'station:',
            detectedDrivers: []
        };

        // Auto-detect driver types from CSV content

        // JSON Export functionality
        function generateFullExport() {
            if (!appData) {
                showToast('No data to export');
                return;
            }

            const exportData = {
                metadata: {
                    exportVersion: "2.0",
                    exportDate: new Date().toISOString(),
                    sourceFile: document.getElementById('fileName').textContent,
                    stationInfo: {
                        detectedFormat: "auto-detected",
                        driverType: detectedConfig.driverType,
                        detectedDrivers: detectedConfig.detectedDrivers,
                        pointCount: appData.points.size,
                        equipmentCount: appData.devices.length
                    }
                },
                hierarchy: generateHierarchy(),
                templates: generateTemplatesExport(),
                apiConfig: {
                    recommended: "obix",
                    endpoints: {
                        obix: `${document.getElementById('serverUrl')?.value || '{server}'}/obix`,
                        fox: `${document.getElementById('serverUrl')?.value || '{server}'}:4911`,
                        rest: `${document.getElementById('serverUrl')?.value || '{server}'}/api`
                    }
                }
            };

            return exportData;
        }

        function generateHierarchy() {
            const systems = new Map();

            appData.devices.forEach(device => {
                const pathParts = device.path.split('/').filter(p => p);

                // Extract system info from path
                const systemName = pathParts.length >= 3 ? pathParts[2] : 'Unknown';

                if (!systems.has(systemName)) {
                    systems.set(systemName, {
                        name: systemName,
                        path: `/${pathParts.slice(0, 3).join('/')}`,
                        equipment: []
                    });
                }

                // Generate equipment entry with all translation formats
                const deviceTranslation = ordTranslator.translate(device.path);

                const equipmentEntry = {
                    id: device.name.toLowerCase().replace(/[^a-z0-9]/g, '_'),
                    name: device.name,
                    displayName: device.name,
                    type: detectEquipmentType(device.name),
                    template: findTemplateId(device),
                    paths: {
                        csv: device.path,
                        ord: deviceTranslation.ord,
                        obix: deviceTranslation.obixPath,
                        fox: deviceTranslation.foxUrl
                    },
                    points: device.points.map(point => {
                        const pointTranslation = ordTranslator.translate(device.path, point.name);
                        return {
                            id: `${device.name.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${point.name.toLowerCase().replace(/[^a-z0-9]/g, '_')}`,
                            name: point.name,
                            displayName: point.name,
                            paths: {
                                csv: point.path,
                                ord: pointTranslation.ord,
                                obix: pointTranslation.obixPath,
                                obixValue: pointTranslation.obixValueUrl
                            },
                            metadata: {
                                unit: detectUnit(point.name),
                                precision: 1,
                                writable: detectWritable(point.name)
                            }
                        };
                    })
                };

                systems.get(systemName).equipment.push(equipmentEntry);
            });

            return {
                building: "Station",
                systems: Array.from(systems.values())
            };
        }

        function generateTemplatesExport() {
            return appData.templates.exact.map((template, index) => ({
                id: `template_${index + 1}`,
                name: `Template ${index + 1}`,
                pointSignatures: template.points.map(p => p.name),
                instanceCount: template.devices.length,
                instances: template.devices.map(d => d.name)
            }));
        }

        function detectEquipmentType(name) {
            const name_lower = name.toLowerCase();
            if (name_lower.includes('ahu')) return 'AHU';
            if (name_lower.includes('vav')) return 'VAV';
            if (name_lower.includes('chiller')) return 'Chiller';
            if (name_lower.includes('boiler')) return 'Boiler';
            if (name_lower.includes('pump')) return 'Pump';
            if (name_lower.includes('fan')) return 'Fan';
            return 'Generic';
        }

        function detectUnit(pointName) {
            const name_lower = pointName.toLowerCase();
            if (name_lower.includes('temp')) return 'Â°F';
            if (name_lower.includes('pressure')) return 'PSI';
            if (name_lower.includes('humidity')) return '%RH';
            if (name_lower.includes('flow')) return 'CFM';
            if (name_lower.includes('position') || name_lower.includes('damper')) return '%';
            return '';
        }

        function detectWritable(pointName) {
            const name_lower = pointName.toLowerCase();
            return name_lower.includes('setpoint') ||
                   name_lower.includes('command') ||
                   name_lower.includes('override') ||
                   name_lower.includes('position');
        }

        function findTemplateId(device) {
            const templateIndex = appData.templates.exact.findIndex(t =>
                t.devices.some(d => d.path === device.path)
            );
            return templateIndex >= 0 ? `template_${templateIndex + 1}` : null;
        }

        function downloadJSON() {
            const exportData = generateFullExport();
            const json = JSON.stringify(exportData, null, 2);

            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `niagara_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('JSON export downloaded');
        }

        function copyJSONToClipboard() {
            const exportData = generateFullExport();
            const json = JSON.stringify(exportData, null, 2);

            const textarea = document.createElement('textarea');
            textarea.value = json;
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                showToast('JSON copied to clipboard');
            } catch (err) {
                showToast('Copy failed');
            }

            document.body.removeChild(textarea);
        }

        function exportQuote() {
            const quote = generateQuote();

            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>BAS Scope of Work - ${new Date().toLocaleDateString()}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                        .header { margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .template-item { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; }
                        .template-header { font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
                        .template-details { margin: 10px 0; }
                        .equipment-list { font-size: 14px; color: #666; }
                        .summary { margin-top: 30px; padding: 20px; background: #e8f4fd; border-radius: 8px; }
                        .summary h3 { color: #2c3e50; margin-top: 0; }
                        .summary-item { margin: 8px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Building Automation System - Scope of Work</h1>
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                        <p><strong>Project:</strong> ${document.getElementById('fileName').textContent}</p>
                        <p><strong>Generated by:</strong> Niagara Navigator</p>
                    </div>

                    <h2>Template Breakdown</h2>
                    ${quote.templates.map(t => `
                        <div class="template-item">
                            <div class="template-header">${t.name}</div>
                            <div class="template-details">
                                <strong>Equipment Count:</strong> ${t.deviceCount} units<br>
                                <strong>Points per unit:</strong> ${t.pointCount}<br>
                                <strong>Hours per unit:</strong> ${t.hoursPerUnit}<br>
                                <strong>Total hours:</strong> ${t.totalHours}
                            </div>
                            <div class="equipment-list">
                                <strong>Equipment:</strong> ${t.devices.join(', ')}
                            </div>
                        </div>
                    `).join('')}

                    <div class="summary">
                        <h3>Project Summary</h3>
                        <div class="summary-item"><strong>Total Equipment:</strong> ${quote.totalEquipment} units</div>
                        <div class="summary-item"><strong>Total Data Points:</strong> ${quote.totalPoints}</div>
                        <div class="summary-item"><strong>Total Labor Hours:</strong> ${quote.totalHours}</div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Template</th>
                                <th>Units</th>
                                <th>Points/Unit</th>
                                <th>Hours/Unit</th>
                                <th>Total Hours</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${quote.templates.map(t => `
                                <tr>
                                    <td>${t.name}</td>
                                    <td>${t.deviceCount}</td>
                                    <td>${t.pointCount}</td>
                                    <td>${t.hoursPerUnit}</td>
                                    <td>${t.totalHours}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `BAS_Quote_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Quote/Scope exported');
        }

        function generateQuote() {
            const configuredTemplates = [];

            appData.templates.exact.forEach((template, index) => {
                const settings = templateSettings[index];
                if (settings?.name && settings?.hours > 0) {
                    configuredTemplates.push({
                        name: settings.name,
                        hoursPerUnit: settings.hours,
                        deviceCount: template.devices.length,
                        pointCount: template.points.length,
                        totalHours: settings.hours * template.devices.length,
                        devices: template.devices.map(d => d.name)
                    });
                }
            });

            return {
                templates: configuredTemplates,
                totalEquipment: configuredTemplates.reduce((sum, t) => sum + t.deviceCount, 0),
                totalPoints: configuredTemplates.reduce((sum, t) => sum + (t.deviceCount * t.pointCount), 0),
                totalHours: configuredTemplates.reduce((sum, t) => sum + t.totalHours, 0)
            };
        }

        function updateServerUrl() {
            const serverUrl = document.getElementById('serverUrl').value;

            // Update the ORD translator with new server URL but keep detected config
            ordTranslator = new ORDTranslator({
                driverType: detectedConfig.driverType,
                stationPrefix: detectedConfig.stationPrefix,
                serverUrl: serverUrl
            });
        }

        function updateDetectedDriversDisplay() {
            const displayElement = document.getElementById('detectedDrivers');
            if (detectedConfig.detectedDrivers.length > 0) {
                displayElement.textContent = detectedConfig.detectedDrivers.join(', ');
                displayElement.style.color = 'var(--success-color)';
            } else {
                displayElement.textContent = 'None detected';
                displayElement.style.color = 'var(--text-muted)';
            }
        }

        function openDashboardBuilder() {
            const exportData = generateFullExport();
            if (!exportData) return;

            // Create a new window/tab with the dashboard builder
            const json = JSON.stringify(exportData, null, 2);
            const url = 'dashboard-builder.html?data=' + encodeURIComponent(btoa(json));
            window.open(url, '_blank');
        }

        // Interaction functions
        function copyORD(point) {
            // Generate relativized ORD for use in Niagara graphics
            let relativizedORD;

            // Check for FCU points first (e.g., /VRF_System/points/FCU1_1/ac_StartStopStatus_1)
            if (point.path.includes('/points/') && /\/points\/FCU\d+_\d+\//.test(point.path)) {
                // FCU devices: points are directly under the FCU unit
                // e.g., /VRF_System/points/FCU1_1/ac_StartStopStatus_1 â†’ slot:ac_StartStopStatus_1
                relativizedORD = `slot:${point.name}`;
            } else {
                // Determine the device this point belongs to
                let devicePath;
                if (point.parentDevicePath) {
                    // For nested points like RTU1_Points, use parent device
                    devicePath = point.parentDevicePath;
                } else if (point.path.includes('/points/')) {
                    devicePath = point.path.split('/points/')[0];
                } else {
                    devicePath = point.path.substring(0, point.path.lastIndexOf('/'));
                }

                // Find the device to understand its structure
                const device = appData.devices.find(d => d.path === devicePath);

                if (device && device.isVRFUnit) {
                    // VRF FCU devices: points are directly under the device
                    // e.g., /VRF_System/points/FCU1_1/ac_StartStopStatus_1 â†’ slot:ac_StartStopStatus_1
                    relativizedORD = `slot:${point.name}`;
                } else if (point.pointFolder) {
                    // Point is in a nested folder like RTU1_Points
                    // e.g., /RTU$2d1/points/RTU1_Points/Alarm$20Status â†’ slot:points/RTU1_Points/Alarm$20Status
                    relativizedORD = `slot:points/${point.pointFolder}/${point.name}`;
                } else if (point.hasPointsFolder || point.path.includes('/points/')) {
                    // Point is in a standard points folder
                    // e.g., /DOAS$2d1/points/pointName â†’ slot:points/pointName
                    relativizedORD = `slot:points/${point.name}`;
                } else {
                    // Point is directly under the equipment (rare case)
                    relativizedORD = `slot:${point.name}`;
                }
            }

            // Create textarea, select, copy, remove
            const textarea = document.createElement('textarea');
            textarea.value = relativizedORD;
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                showToast(`Copied: ${relativizedORD}`);
            } catch (err) {
                showToast('Copy failed');
            }

            document.body.removeChild(textarea);
        }

        // Helper function for copying points from detail panel
        function copyPointFromDetail(pointName, hasPointsFolder, devicePath, pointFolder = '') {
            const point = {
                name: pointName,
                hasPointsFolder: hasPointsFolder,
                pointFolder: pointFolder || null,
                path: hasPointsFolder ? `${devicePath}/points/${pointName}` : `${devicePath}/${pointName}`
            };
            copyORD(point);
        }
        
        function showDeviceDetail(path) {
            const device = appData.devices.find(d => d.path === path);
            if (!device) return;
            
            const template = appData.templates.exact.find(t => 
                t.devices.some(d => d.path === path)
            );
            
            const partials = appData.templates.partial.filter(p => 
                p.t1 === template || p.t2 === template
            );
            
            let html = `
                <div class="detail-header">
                    <h3>âš™ï¸ ${device.name}</h3>
                    <div style="font-size: 12px; opacity: 0.9;">${device.path}</div>
                </div>
            `;
            
            if (template) {
                const idx = appData.templates.exact.indexOf(template) + 1;
                html += `
                    <div class="detail-section">
                        <h4>Template ${idx}</h4>
                        <div>${template.devices.length} devices (click to navigate):</div>
                        ${template.devices.map(d => 
                            `<div class="device-link ${d.path === path ? 'current' : ''}" 
                                 onclick="showDeviceDetail('${d.path}')"
                                 style="background: ${d.path === path ? '#3498db' : '#f8f9fa'}; 
                                        color: ${d.path === path ? 'white' : 'inherit'};">
                                ${d.name}
                            </div>`
                        ).join('')}
                    </div>
                    
                    <div class="detail-section">
                        <h4>Points (${template.points.length}) - Click to copy</h4>
                        ${template.points.map(p =>
                            `<div class="detail-point"
                                  onclick="copyPointFromDetail('${p.name.replace(/'/g, "\\'")}', ${p.hasPointsFolder}, '${device.path}', '${(p.pointFolder || '').replace(/'/g, "\\'")}')"
                                  title="Click to copy: slot:${device.isVRFUnit ? '' : (p.hasPointsFolder ? (p.pointFolder ? `points/${p.pointFolder}/` : 'points/') : '')}${p.name}">
                                ${p.name}
                            </div>`
                        ).join('')}
                    </div>
                `;
                
                if (partials.length > 0) {
                    html += `
                        <div class="detail-section">
                            <h4>Partial Matches</h4>
                            ${partials.map(p => {
                                const other = p.t1 === template ? p.t2 : p.t1;
                                const otherIdx = appData.templates.exact.indexOf(other) + 1;
                                
                                // Find differences
                                const mainPoints = template.points;
                                const otherPoints = other.points;
                                
                                const missing = mainPoints.filter(mp => 
                                    !otherPoints.some(op => op.name === mp.name)
                                );
                                
                                const extra = otherPoints.filter(op => 
                                    !mainPoints.some(mp => mp.name === op.name)
                                );
                                
                                return `
                                    <div style="padding: 8px; margin: 8px 0; background: white; border-radius: 4px; border: 1px solid #dee2e6;">
                                        <div style="font-weight: bold; color: #2c3e50;">Template ${otherIdx}: ${p.percent}% match</div>
                                        <div style="font-size: 11px; color: #6c757d; margin: 4px 0;">${p.matching} of ${p.total} points match</div>
                                        
                                        <div style="margin-top: 8px; font-size: 11px; color: #6c757d;">
                                            <strong>Devices (${other.devices.length}):</strong>
                                            ${other.devices.slice(0, 3).map(d => d.name).join(', ')}${other.devices.length > 3 ? '...' : ''}
                                        </div>
                                        
                                        ${missing.length > 0 ? `
                                            <div style="margin-top: 8px;">
                                                <div style="font-size: 11px; font-weight: bold; color: #c62828;">Missing from Template ${otherIdx}:</div>
                                                ${missing.map(m => 
                                                    `<div class="diff-point missing">â€¢ ${m.name}</div>`
                                                ).join('')}
                                            </div>
                                        ` : ''}
                                        
                                        ${extra.length > 0 ? `
                                            <div style="margin-top: 8px;">
                                                <div style="font-size: 11px; font-weight: bold; color: #2e7d32;">Extra in Template ${otherIdx}:</div>
                                                ${extra.map(e => 
                                                    `<div class="diff-point extra">â€¢ ${e.name}</div>`
                                                ).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
            }
            
            document.getElementById('detailPanel').innerHTML = html;
            document.getElementById('detailPanel').classList.add('show');
        }
        
        function showView(view) {
            currentView = view;
            document.querySelectorAll('.toolbar .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Hide all views first
            document.getElementById('treeView').style.display = 'none';
            document.getElementById('templatesView').style.display = 'none';
            document.getElementById('comparisonView').style.display = 'none';

            // Show selected view
            if (view === 'tree') {
                document.getElementById('treeView').style.display = 'block';
            } else if (view === 'templates') {
                document.getElementById('templatesView').style.display = 'block';
                closeDetail();
            } else if (view === 'comparison') {
                document.getElementById('comparisonView').style.display = 'block';
                closeDetail();
                if (comparisonActive) {
                    updateComparison();
                }
            }
        }
        
        function expandAll() {
            document.querySelectorAll('.tree-children').forEach(el => {
                el.classList.add('open');
            });
        }
        
        function collapseAll() {
            document.querySelectorAll('.tree-children').forEach(el => {
                el.classList.remove('open');
            });
        }
        
        function closeDetail() {
            document.getElementById('detailPanel').classList.remove('show');
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        console.log('Niagara Navigator - CSV Point Explorer');
    </script>
</body>
</html>